<!DOCTYPE html><!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]--><!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]--><!--[if IE 8]> <html class="no-js lt-ie9" lang=""> <![endif]--><!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="index,follow" />
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-1" />
<meta name="keywords" content="bregier, fichier, file, frederic, gateway, goldengate, http, java, libre, moniteur, monitor, open, openr66, route, source, ssh, transfer, transfert, waarp" />
<meta name="generator" content="Site Studio 6 (www.effectivestudios.com)" />
<meta name="description" content="Waarp project" />
<link rel="stylesheet" href="Waarp.css" type="text/css" />
<style type="text/css">
a {
	color:#0000FF;
	text-decoration:underline;
}
a:visited {
	text-decoration:underline;
}
a:hover {
	text-decoration:underline;
}
a img {
	border:#000000 0px none;
}
</style>
<title>Waarp - R66Cluster-HA</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="css/magic-bootstrap-min.css">
<!-- special CSS -->
<style type="text/css">
@-moz-document url-prefix() { fieldset { display: table-cell; } }
</style>
<!-- JQuery -->
<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
<script src="js/modernizr-2.8.3-respond-1.4.2.min.js"></script>
<!-- Bootstrap -->
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<link rel="stylesheet" href="Waarp.css" type="text/css" />
<script>
$( document ).ready(function(){
 $.get( "res/waarpmenu.html", function(data) {
 $( "#waarpmenu" ).html(data);
 $("body").removeAttr("class").removeAttr( "style" );
 $("#Comp2_sys_doctext").addClass("panel-body container-fluid");
 var curpage= "r660/r66howto0/r66wiki0/r66ha";
 var splitPages = curpage.split("/");
 $.each( splitPages, function( index, value ){ $("#"+value).addClass("active"); });
  $('ul.dropdown-menu [data-toggle=dropdown]').on('click', function(event) {
   event.preventDefault(); 
   event.stopPropagation(); 
   $(this).parent().siblings().removeClass('open');
   $(this).parent().toggleClass('open');
  });
 });
});
</script>
<style type="text/css">
.dropdown-submenu{position:relative;}
.dropdown-submenu>.dropdown-menu{top:0;left:100%;margin-top:-6px;margin-left:-1px;-webkit-border-radius:0 6px 6px 6px;-moz-border-radius:0 6px 6px 6px;border-radius:0 6px 6px 6px;}
.dropdown-submenu>a:after{display:block;content:" ";float:right;width:0;height:0;border-color:transparent;border-style:solid;border-width:5px 0 5px 5px;border-left-color:#cccccc;margin-top:5px;margin-right:-10px;}
.dropdown-submenu:hover>a:after{border-left-color:#555;}
.dropdown-submenu.pull-left{float:none;}.dropdown-submenu.pull-left>.dropdown-menu{left:-100%;margin-left:10px;-webkit-border-radius:6px 0 6px 6px;-moz-border-radius:6px 0 6px 6px;border-radius:6px 0 6px 6px;}
.h1 { font-size:14px; color:#333333; font-weight:bold;}
.h2, .h3 { font-size:12pt; color:#333333; font-weight:bold; }
.h4, .h5, .h6 { font-size:13px; color:#333333; font-weight:bold; }
</style>
</head>
<body class="normal" style="font-family:Verdana,sans-serif;font-size:8pt;color:#000000;margin:0px;padding:0px;background-color:#FFFFFF;">

<div id="Comp1_CodeRelayer"><!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->
<div class="cover" id="waarpmenu" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1693657-4', 'auto');
  ga('send', 'pageview');

</script>
</div><h1 class="h1">R66Cluster-HA</h1><div id="Comp3_sys_doctext"><h1 class="h1" style="text-align:justify;">Cluster configuration and High availability consideration</h1>
<p style="text-align:justify;"><span style="font-size:11pt;">The cluster principle for Waarp R66 is as the following:</span></p>
<ul>
<li><p style="text-align:justify;"><span style="font-size:11pt;">Having a load balancer, based on TCP, allowing to maintain an open connection to stay open, and to balance new connection with a pool of R66 servers, using probably the less connection as elected</span></p></li>

<li><p style="text-align:justify;"><span style="font-size:11pt;">The IP/port of the load balancer service is the R66 service address associated with the pool of servers</span></p></li>

<li><p style="text-align:justify;"><span style="font-size:11pt;">If the load balancer is transparent, the IP of the client is visible from the R66 servers in the pool. If the load balancer is not transparent, the IP of the client is replaced by the IP of the load balancer itself, therefore the R66 servers in the poll will not be able to check the IP addresses of the partners.</span></p></li>

<li>
<p style="text-align:justify;"><span style="font-size:11pt;">All servers in the pool will have the exact same IDs (SSL and not SSL), sharing the same database, the same filesystem sub part (work, out at least, probably also in, arch and conf). The configuration must set the multiplemonitor to the number of total available servers in the pool (at most available).</span></p></li></ul>
<p style="text-align:justify;"><span style="font-size:11pt;">This should enable high availability on the following:</span></p>
<ul>
<li><div style="text-align:justify;"><span style="font-size:11pt;">a balance between several R66 servers (thus leading to less risk of "high throughput side effects")</span> </div></li>

<li><div style="text-align:justify;"><span style="font-size:11pt;">a high availability in the sens that if one server is down in the pool, the others will ensure the continuity of the service</span> </div></li>

<li>
<div style="text-align:justify;"><span style="font-size:11pt;">a restart on disconnection (after a crash or stop of one server in the pool) using standard restart procedure of transfer, going to another server but as they all share at least the database, work and out directory, the transfer can restart easily</span></div></li></ul>
<p style="text-align:justify;"><span style="font-size:11pt;">However, a well enough service level could be sustained using simple monitoring on R66 server, forcing its stop/restart according to the results, giving almost the same result than cluster mode. </span></p>
<p style="text-align:justify;"><span style="font-size:11pt;">Indeed, when a server will retry a connection, it will respect a minimal delay between 2 checks, therefore the delay for the monitoring and restart is around this check delay or a factor of 2 of this delay. For instance, if the timeout/delay is setup to 30s, then the restart should occur in less than 60s to be almost equal to high availability.</span></p>
<p style="text-align:justify;">&nbsp;</p>
<p style="text-align:justify;"><span style="font-size:11pt;">Finally, <strong>regarding the database access</strong>, it is important to note that R66 monitors have a certain level of tolerance of unavailability of the database. As long as the transfer is not finishing, the database updates (which log the current status of the transfer) can be ignored. Each time, if the database connection is lost, the server will retry to open new connections when needed. However, when the transfer is finishing (in error or correct), the R66 server MUST save the status, and therefore, if it cannot, it sends back to its partner an internal erropr and will keep this transfer status as it was the las time it was saved. The next time this transfer will be restarted, it will restart form the point saved in the database.</span></p>
<p style="text-align:justify;">&nbsp;</p>
<p style="text-align:justify;"></p>
<p style="text-align:justify;"></p>
<p style="text-align:justify;"></p>
<p style="text-align:justify;"></p>
<p style="text-align:justify;">&nbsp;</p>
<p style="text-align:justify;"><span style="font-size:11pt;background-color:#CCCCCC;"><strong>Some specific technical items</strong></span></p>
<h1 class="h1">Usage of the same database between several R66 servers</h1>
<blockquote>
<p style="text-align:justify;"><span style="font-size:10pt;">In case a database is shared among several R66 servers (with different names, so not in Multiple Monitors support option), the following tables will be totally shared:</span></p>
<ul>
<li><p style="text-align:justify;"><span style="font-size:10pt;">Host table: all partners definition, including itself will be shared among all servers. It implies also that the Key used to crypt/uncrypt the password are the same for all servers sharing the database.</span></p></li>

<li>
<p style="text-align:justify;"><span style="font-size:10pt;">Rules table: all rule definitions will be shared. The difference of real action could be done either on the recv/send part of the tasks, but also using local variables (see the R66 Task Options) or local scripts</span></p></li></ul>
<p style="text-align:justify;"><span style="font-size:10pt;">The following tables, even if shared, will have different entries for each server:</span></p>
<ul>
<li><p style="text-align:justify;"><span style="font-size:10pt;">Configuration table: the bandwidth limitation will be independent for each server</span></p></li>

<li><p style="text-align:justify;"><span style="font-size:10pt;">Runner table: each transfer will be owned by one server only. Even if 2 servers are partners for the very same transfer, there will be 2 lines in the database, one for each server (requester and requested).</span></p></li>

<li>
<p style="text-align:justify;"><span style="font-size:10pt;">MultipleMonitor table: this table is of no use in case of no multiple monitor usage ; in case of multiple monitor usage with several clusters on the same database, each cluster will act as a single host (so sharing or not sharing accordingly) and one line per cluster will be setup in this table.</span><br /></p></li></ul></blockquote>
<h1 class="h1">Usage of&nbsp;Multiple Monitors&nbsp;support</h1>
<blockquote>
<p style="text-align:justify;"><span style="font-size:10pt;">In order to improve reliability of the OpenR66 File Transfer Monitors and the scalability, we propose a new option that allows to spread the load behind a Load Balancer in TCP mode (as HA-Proxy) and a shared storage (as a simple NAS).</span></p>
<ol>
<li><p><strong><span style="font-size:10pt;">multiplemonitors</span></strong><span style="font-size:10pt;">=1 =&gt;&nbsp;No multiple monitors will be supported (single instance)&nbsp;</span> </p></li>

<li>
<p><strong><span style="font-size:10pt;">multiplemonitors</span></strong><span style="font-size:10pt;">=</span><em><span style="font-size:10pt;">n</span></em><span style="font-size:10pt;"> =&gt;&nbsp;n servers will be used as a single instance to spread the load and increase the high availability&nbsp;</span></p></li></ol>
<p style="text-align:justify;"><span style="font-size:10pt;">Note that some specific attentions are needed such as to share the IN, OUT and WORK&nbsp;storages such that any servers can act on those files and any other storages that must be shared from the beginning of the transfer (pre-task) to the end of the transfer (post-task),&nbsp;and as to configure correctly the Load Balancer in TCP mode such as to spread the load and keep the connection once opened between 2 partners.</span></p>
<p style="text-align:justify;"><span style="font-size:10pt;">The principle is as follow:</span></p>
<ul>
<li><p style="text-align:justify;"><span style="font-size:10pt;">Put in place a TCP load balancer that allows to maintain a TCP connection with one server behind and that allows to spread the new connection attempts on the pool of servers available. The algorithm to spread the load could be for instance: the less connections opened at that time. A detection on open port could be enough to test the availability of the service. In more complex configuration, one could also implement a Java method that will do a &ldquo;message&rdquo; call to the proposed target server in order to test its availability.</span></p></li>

<li><p style="text-align:justify;"><span style="font-size:10pt;">The IP/Port of the load balancer service will be the IP/port of the R66 service, behind it, you will have a set of R66 servers with their own IP/port couples internally (on which the load balancer spreads the load).</span></p></li>

<li><p style="text-align:justify;"><span style="font-size:10pt;">Note that if the LB is &ldquo;transparent&rdquo;, meaning the IP from the client is not changed from the real server behind, the IP check could be possible on that pool of servers. Reversely, if the IP shown to the real R66 server is the one from the LB, the IP check will not be possible. However note that if the LB is transparent, it does not prevent that the client might still see the LB IP, and not the real R66 server's IP, and therefore preventing the IP check on client side. So a particular attention is needed if one wants to enable IP checking while using a LB in front of a pool of R66 servers.</span></p></li>

<li><p style="text-align:justify;"><span style="font-size:10pt;">All R66 servers behind the LB will share the exact same name (ID), both for non SSL and SSL, and will share also the same database. They will have to share also the IN, OUT and WORK directories, and probably any other resources needed for the pre, post and error tasks (through a NAS for instance).</span></p></li>

<li>
<p style="text-align:justify;"><span style="font-size:10pt;">All R66 servers will have to specify the same multiplemonitor option with the number of servers in the pool.</span></p></li></ul>
<p style="text-align:justify;"><span style="font-size:10pt;">In theory, this enables the following HA capabilities:</span></p>
<ul>
<li><p style="text-align:justify;"><span style="font-size:10pt;">A load balance of all transfers among several clusters (horizontal scalability).</span></p></li>

<li>
<p style="text-align:justify;"><span style="font-size:10pt;">A restart on disconnection, even on a crash of the original R66 server, since the new connection will go through the LB algorithm.</span></p></li></ul>
<p style="text-align:justify;"><span style="font-size:10pt;">Note however that obtaining a HA R66 service does not required absolutely to have this option enabled. Indeed, one could check regularly through a monitoring tool that the service is still responding (using e message for instance), and if not to stop/restart the R66 service accordingly. Since the restart of a request is merely related to the &ldquo;timeout&rdquo; time, a check roughly repeated at that interval should enable a &ldquo;clean&rdquo; HA availability without having the complexity of a LB configuration.</span></p>
<p style="text-align:justify;"><span style="font-size:10pt;">One could also mixed the two solutions, in order to restart one unresponsive server in the HA pool.</span></p></blockquote></div>
</body>
</html>
